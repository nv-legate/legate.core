#!/usr/bin/env bash

yaml_file="";

make_conda_env() {
    mamba env create -n "${DEFAULT_CONDA_ENV:-legate}" -f "${yaml_file}";
}

generate_yaml_file() {
    local cuda_version="${CUDA_VERSION:-${CUDA_VERSION_MAJOR}.${CUDA_VERSION_MINOR}}";
    cuda_version="$(echo "${cuda_version}" | cut -d'.' -f3 --complement)";

    local python_version="${PYTHON_VERSION:-}";

    if [ -z "${python_version}" ]; then
        python_version="$(python3 --version 2>&1 | cut -d' ' -f2 | cut -d'.' -f3 --complement)";
    fi

    yaml_file=~/"$(         \
        ~/legate/scripts/generate-conda-envs.py \
            --os linux                          \
            --compilers                         \
            --ctk ${cuda_version}               \
            --python ${python_version}          \
            --openmpi                           \
            --no-ucx                            \
        | head -n1 | cut -d' ' -f3              \
    )"

    sed -i -re "s/legate-test/${DEFAULT_CONDA_ENV:-legate}/g" "${yaml_file}";
    echo "  - boa" >> "${yaml_file}";

    cp "${yaml_file}" /tmp/out/
    mkdir -p /tmp/env_yaml
    cp "${yaml_file}" /tmp/env_yaml
}

find_yaml_file() {
    pattern="/tmp/env_yaml/*.yaml"
    files=( $pattern )
    yaml_file="${files[0]}"

    if [ -z "${yaml_file:-}" ] || [ ! -f "$yaml_file" ]; then
        return 1
    fi

    return 0
}

main() {
    set -e;
    if ! find_yaml_file; then
        generate_yaml_file;
    fi

    echo YAML file: ${yaml_file}
    cat "${yaml_file}";

    make_conda_env;
}

main "$@";
